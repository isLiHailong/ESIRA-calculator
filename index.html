<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ESIRA Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .input-group {
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"] {
            padding: 5px;
            margin-right: 10px;
            width: 200px;
        }
        button {
            padding: 8px 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ESIRA Calculator</h1>
    
    <!-- 输入参数区 -->
    <section>
        <h2>有效性 (Efficacy)</h2>
        
        <div id="os-inputs">
            <h3>Overall Survival (OS)</h3>
            <div class="input-group">
                <input type="text" placeholder="疗法名称">
                <input type="number" placeholder="HR (Hazard Ratio)">
            </div>
        </div>
        <button onclick="addInput('os-inputs')">添加更多疗法 (OS)</button>
        
        <div id="pfs-inputs">
            <h3>Progression-Free Survival (PFS)</h3>
            <div class="input-group">
                <input type="text" placeholder="疗法名称">
                <input type="number" placeholder="HR (Hazard Ratio)">
            </div>
        </div>
        <button onclick="addInput('pfs-inputs')">添加更多疗法 (PFS)</button>
        
        <h2>安全性 (Safety)</h2>
        <div id="sae-inputs">
            <h3>Serious Adverse Events (SAE)</h3>
            <div class="input-group">
                <input type="text" placeholder="疗法名称">
                <input type="number" placeholder="HR (Hazard Ratio)">
            </div>
        </div>
        <button onclick="addInput('sae-inputs')">添加更多疗法 (SAE)</button>
    </section>

    <!-- 临床终点权重设置 -->
    <section>
        <h2>临床终点权重设置</h2>
        <div class="input-group">
            <label>OS 权重: </label>
            <input type="number" placeholder="OS 权重">
        </div>
        <div class="input-group">
            <label>PFS 权重: </label>
            <input type="number" placeholder="PFS 权重">
        </div>
        <div class="input-group">
            <label>SAE 权重: </label>
            <input type="number" placeholder="SAE 权重">
        </div>
    </section>

    <!-- 交互按钮区 -->
    <section>
        <button onclick="calculateRanking()">计算排名</button>
        <button onclick="generateChart()">一键出图</button>
    </section>

    <!-- 结果展示区 -->
    <section>
        <h2>计算结果</h2>
        <p id="result"></p>
    </section>

    <script>
        // 动态添加输入框
        function addInput(sectionId) {
            const section = document.getElementById(sectionId);
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <input type="text" placeholder="疗法名称">
                <input type="number" placeholder="HR (Hazard Ratio)">
            `;
            section.appendChild(div);
        }
        
        // 动态获取前端输入，生成决策矩阵和疗法名称数组
function getDecisionMatrixAndTherapies() {
    const osInputs = document.querySelectorAll('#os-inputs .input-group');
    const pfsInputs = document.querySelectorAll('#pfs-inputs .input-group');
    const saeInputs = document.querySelectorAll('#sae-inputs .input-group');

    const therapies = [];
    const decisionMatrix = [];

    osInputs.forEach((inputGroup, index) => {
        const therapyName = inputGroup.querySelector('input[type="text"]').value.trim();
        const osHr = parseFloat(inputGroup.querySelector('input[type="number"]').value) || 0;
        const pfsHr = parseFloat(pfsInputs[index]?.querySelector('input[type="number"]').value) || 0;
        const saeHr = parseFloat(saeInputs[index]?.querySelector('input[type="number"]').value) || 0;

        if (therapyName) {
            therapies.push(therapyName);
            decisionMatrix.push([osHr, pfsHr, saeHr]);
        }
    });

    return { therapies, decisionMatrix };
}

// 默认权重设置 (OS, PFS, SAE)
const defaultWeights = [1 / 3, 1 / 3, 1 / 3];

// 获取权重 (优先用户输入，没有则使用默认值)
function getWeights() {
    const osWeight = parseFloat(document.querySelector('input[placeholder="OS 权重"]').value) || defaultWeights[0];
    const pfsWeight = parseFloat(document.querySelector('input[placeholder="PFS 权重"]').value) || defaultWeights[1];
    const saeWeight = parseFloat(document.querySelector('input[placeholder="SAE 权重"]').value) || defaultWeights[2];

    const sum = osWeight + pfsWeight + saeWeight;
    return [osWeight / sum, pfsWeight / sum, saeWeight / sum];
}

// 归一化决策矩阵
function normalizeMatrix(matrix) {
    const columnSums = matrix[0].map((_, colIndex) =>
        matrix.reduce((sum, row) => sum + row[colIndex], 0)
    );

    return matrix.map(row =>
        row.map((value, colIndex) => value / columnSums[colIndex])
    );
}

// 计算加权归一化决策矩阵
function weightedNormalizedMatrix(normalizedMatrix, weights) {
    return normalizedMatrix.map(row =>
        row.map((value, colIndex) => value * weights[colIndex])
    );
}

// 计算正理想解 (PIS) 和负理想解 (NIS)
function calculateIdealSolutions(weightedMatrix) {
    // 所有维度 (OS, PFS, SAE) 都为 "越大越好"
    const PIS = weightedMatrix[0].map((_, colIndex) =>
        Math.max(...weightedMatrix.map(row => row[colIndex]))
    );

    const NIS = weightedMatrix[0].map((_, colIndex) =>
        Math.min(...weightedMatrix.map(row => row[colIndex]))
    );

    return { PIS, NIS };
}

// 计算正理想距离 (PID) 和负理想距离 (NID)
function calculateDistances(weightedMatrix, PIS, NIS) {
    // 正理想距离: 距离最大值 (PIS)
    const PID = weightedMatrix.map(row =>
        Math.sqrt(row.reduce((sum, value, index) => sum + Math.pow(PIS[index] - value, 2), 0))
    );

    // 负理想距离: 距离最小值 (NIS)
    const NID = weightedMatrix.map(row =>
        Math.sqrt(row.reduce((sum, value, index) => sum + Math.pow(value - NIS[index], 2), 0))
    );

    return { PID, NID };
}

// 计算相对重要性指数 (Q_i)
function calculateQScores(weightedMatrix, PIS, NIS) {
        const { PID, NID } = calculateDistances(weightedMatrix, PIS, NIS);
        return PID.map((pid, i) => {
            const nid = NID[i];
            return nid / (pid + nid);
        });
    }

// 计算排名 (基于用户权重或默认权重)
function calculateRanking() {
        // (1) 获取输入数据
        const { therapies, decisionMatrix } = getDecisionMatrixAndTherapies();
        if (therapies.length === 0) {
            alert("请至少填写一个疗法名称和对应HR值!");
            return;
        }

        // (2) 获取权重
        const weights = getWeights();

        // (3) 归一化
        const normalizedMatrix = normalizeMatrix(decisionMatrix);

        // (4) 加权归一化
        const weightedMatrix = weightedNormalizedMatrix(normalizedMatrix, weights);

        // (5) 计算PIS, NIS (都在加权后矩阵进行)
        const { PIS, NIS } = calculateIdealSolutions(weightedMatrix);

        // (6) 计算Q
        const qScores = calculateQScores(weightedMatrix, PIS, NIS);

        // (7) 排名
        const ranking = therapies.map((therapy, index) => ({
            therapy,
            score: qScores[index].toFixed(4)
        })).sort((a, b) => b.score - a.score);

        // (8) 显示结果
        const resultElement = document.getElementById('result');
        resultElement.innerHTML = ranking.map(r => `<p>${r.therapy}: Q Score = ${r.score}</p>`).join('');

    }
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 生成图表数据 (用于一键出图)
    function generateChart() {
        const { therapies, decisionMatrix } = getDecisionMatrixAndTherapies();
        if (therapies.length === 0) {
            alert("请至少填写一个疗法名称和对应HR值!");
            return;
        }

        // 生成不同权重 (Efficacy Weight) 下的 Q Score 数据
        const weightSteps = Array.from({ length: 11 }, (_, i) => i * 0.1);
        const chartData = therapies.map((therapy, index) => {
            const qScores = weightSteps.map(efficacyWeight => {
                const weights = [efficacyWeight / 2, efficacyWeight / 2, 1 - efficacyWeight];
                const normalizedMatrix = normalizeMatrix(decisionMatrix);
                const weightedMatrix = weightedNormalizedMatrix(normalizedMatrix, weights);
                const { PIS, NIS } = calculateIdealSolutions(weightedMatrix);
                const qScores = calculateQScores(weightedMatrix, PIS, NIS);
                return qScores[index];
            });

            return { label: therapy, data: qScores };
        });

        // Chart.js 数据集格式
        const datasets = chartData.map((item, index) => ({
            label: item.label,
            data: item.data,
            borderColor: `hsl(${(index * 60) % 360}, 70%, 50%)`,
            fill: false
        }));

        // 销毁旧图表 (避免多次点击一键出图出现重复图表)
        if (window.chartInstance) {
            window.chartInstance.destroy();
        }

        // 创建图表 Canvas
        const chartContainer = document.getElementById('chartContainer');
        if (!chartContainer) {
            const canvas = document.createElement('canvas');
            canvas.id = 'chartCanvas';
            document.body.appendChild(canvas);
        }

        // 使用 Chart.js 绘制折线图
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        window.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weightSteps.map(w => w.toFixed(2)),
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'Q Score vs The Weight of Efficacy' }
                },
                scales: {
                    x: { title: { display: true, text: 'The Weight of Efficacy' } },
                    y: { title: { display: true, text: 'Q Score' }, min: 0, max: 1 }
                }
            }
        });
    }

    </script>
</body>
</html>

